{% extends 'general/base.html' %}

{% block title %}{{ Category }}{% endblock %}

{% block content %}
<div class="pricing-header p-3 pb-md-4 mx-auto text-center">
      <h1 class="display-4 fw-normal">{{ Category }}{{ Category.amount }}</h1>
</div>
<div class="product_list row">
  <div class="col-2">
    <div class="filters">
      {% if not Category.features.fields.items %}
      <span>There is no filters</span>
      {% else %}
      {% for field, values in Category.features.fields.items %}
      <span>{{ field }}</span>
      <div class="row row-cols-auto" name="myfilters">
        {% for value in values %}
        <div class="col-6">
          <input class="filter_checkbox" type="checkbox" id="{{ field }}" name="{{field}}-{{value}}" data-value="{{ value }}">
          <label>{{ value }}</label>
        </div>
        {% endfor %}
      </div>
      {% endfor %}
      <button type="button" class="btn btn-primary btn-sm" onclick="checkbox_clicked(this)">Apply</button>
      {% endif %}
    </div>
  </div>
        <div class="products col">
      {% for item in Products %}
          <div class="card mb-4 rounded-3 shadow-sm">
            <a href="{{ item.get_absolute_url }}">
              <div class="card-header py-3">
                  <h4 class="">{{ item.name }}{{ item.number_of_shops }}</h4>
              </div>
            </a>
              <button onclick="clicked(this)" id="{{ item.id }}">Add to basket</button>
          </div>
      {% endfor %}
        </div>

</div>

<div class="pagination">
  <nav class="step-links">
    <ul>
      {% for page in paginator.page_range %}
      <li class="page-num">
        <a href="?page={{ page }}">{{ page }}</a>
      </li>
      {% endfor %}
    </ul>      
  </nav>
</div>
<script>
  
window.onload = function() {
  var coded = '{{ checkboxes }}'.split('~');

  if (coded != '[]') {
  coded.forEach(element => {
    const checkbox = document.getElementsByName(element)[0];
    checkbox.checked = 'yes';
  })
  }
}
  
  function send_productId(obj){
    $.ajax({
      type: "POST",
      url: '{% url "basket:basket_add" %}',
      data: {
        productid: obj.id,
        csrfmiddlewaretoken: "{{csrf_token}}",
      },
      success: function () {},
      error: function () {},
    });
  }

  function clicked(obj) {
    send_productId(obj);
  }


  function find_checked(obj) {
    const checkboxes = document.querySelectorAll(".filter_checkbox");
    var checkboxes_checked = {};
    checkboxes.forEach(element => {
      if (element.checked) {
        if (checkboxes_checked[element.id] == null) {
          checkboxes_checked[element.id] = [];
        }
        checkboxes_checked[element.id].push(element.dataset.value);
      }
    });
    return checkboxes_checked;
  }

  
  
  function checkbox_clicked(obj) {
    const checkboxes = find_checked(obj);
    const filters = [];
    for (const [key, value] of Object.entries(checkboxes)) {
      filters.push(key + '=' + value.join("~"));
    }
    const filter_string = filters.join('&');
    console.log(filter_string);
    const url = '{% url "store:product_list" slug %}' + filter_string;
    window.location.href = url;
  }
  
</script>

{% endblock %}